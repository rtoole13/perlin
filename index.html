<!DOCTYPE html>
<title>Test</title>
<style>
.centerbox {
    display: -webkit-box;
        -webkit-box-orient: horizontal;
        -webkit-box-pack: center;
        -webkit-box-align: center;
    display: -moz-box;
        -moz-box-orient: horizontal;
        -moz-box-pack: center;
        -moz-box-align: center;
    width: 100%;
    height: 100%;
    margin: 0; padding: 0;
}
body, html {width: 100%; height: 100%; padding: 0; margin: 0;}
canvas {
    box-shadow: 0 0 10px #777;
    width: 1024px;
    height: 760px;
}
body {
  background-color: #eee;
}
</style>
<div class='centerbox'><canvas></canvas></div>
<script type="text/javascript" src="perlin.js"></script>
<script type="text/javascript" src="dat.gui.min.js"></script>
<script type="text/javascript" src="engine.js"></script>
<script type="text/javascript">
"use strict";

var canvas,
    canvasContext,
    grid,
    gridSpacing = 20,
    gui,
    params,
    particleCount,
    particles,
    accelContributionFromField = 30,
    velocityCap = 3,
    velocityCapSq = velocityCap * velocityCap,

    currentFrame,
    lastFrame,
    dt,
    dtMax = 1/15,
    timeFactor;

window.onload = function(){
    canvas = document.getElementsByTagName('canvas')[0];
    canvas.width = 1024;
    canvas.height = 760;
    canvasContext = canvas.getContext('2d');
    gui = new dat.GUI();
    params = {dt: dtMax};
    init();
}

function initializeGUI(){
    //gui.add(params, 'dt', 0, 100).listen();

}
function init(){
    //Initialization
    timeFactor = 0;
    noise.seed(Math.random());
    grid = new Grid(Math.floor(canvas.height / gridSpacing), Math.floor(canvas.width / gridSpacing), canvas.width, canvas.height);
    initializeParticles();

    drawBackground('white');
    requestAnimationFrame(main);
}

function initializeParticles(){
    particleCount = canvas.width * canvas.height / 1000;
    particles = [];
    for (var i = 0; i < particleCount; i ++){
        var particle = new Particle(Math.random() * canvas.width, Math.random() * canvas.height, 8);
        particles.push(particle);
    }
}

function main(){
    currentFrame = new Date();
    dt = (currentFrame - lastFrame) / 1000.0;
    dt = (dt < dtMax)? dt : dtMax; //cap dt in the event of tabbing away
    lastFrame = currentFrame;
    timeFactor += 0.001;
    update(dt);
    draw();
    requestAnimationFrame(main);
}

function update(dt){
    //Update field and particles
    grid.update();
    updateParticles(dt);
}

function updateParticles(dt){
    for (var i = 0; i < particleCount; i++){
        //FIX add to quadtree
        particles[i].update(dt);
    }
}

function draw(){
    drawBackground('white');
    grid.draw();
    drawParticles();
}

function drawBackground(color){
    canvasContext.save();
    canvasContext.fillStyle = color;
    canvasContext.fillRect(0,0,canvas.width, canvas.height);
    canvasContext.restore();
}
function drawParticles(){
    for (var i = 0; i < particleCount; i++){
        particles[i].draw();
    }
}
/*
var image = canvasContext.createImageData(canvas.width, canvas.height);
var data = image.data;
var start = Date.now();
noise.seed(Math.random());
for (var x = 0; x < canvas.width; x++) {
    for (var y = 0; y < canvas.height; y++) {
        var value = Math.abs(noise.simplex3(x / 100, y / 100, 0));
        value *= 256;
        var cell = (x + y * canvas.width) * 4;
       
        data[cell] = data[cell + 1] = data[cell + 2] = value;
        data[cell + 3] = 255; // alpha.
        //data[cell] += Math.max(0, (25 - value) * 8);

    }
}

canvasContext.putImageData(image, 0, 0);
*/
</script>
</html>