<!DOCTYPE html>
<title>Test</title>
<style>
.centerbox {
    display: -webkit-box;
        -webkit-box-orient: horizontal;
        -webkit-box-pack: center;
        -webkit-box-align: center;
    display: -moz-box;
        -moz-box-orient: horizontal;
        -moz-box-pack: center;
        -moz-box-align: center;
    width: 100%;
    height: 100%;
    margin: 0; padding: 0;
}
body, html {width: 100%; height: 100%; padding: 0; margin: 0;}
canvas {
    box-shadow: 0 0 10px #777;
    width: 1024px;
    height: 760px;
}
body {
  background-color: #eee;
}
</style>
<div class='centerbox'><canvas></canvas></div>
<script type="text/javascript" src="perlin.js"></script>
<script type="text/javascript" src="dat.gui.min.js"></script>
<script type="text/javascript" src="engine.js"></script>
<script type="text/javascript" src="gui.js"></script>
<script type="text/javascript">
"use strict";

var canvas,
    canvasContext,
    grid,
    gridSpacing = 20,
    gui,
    params,
    particleCount,
    particles,
    accelContributionFromField = 0.5,
    velocityCap = 1.5,
    velocityCapSq = velocityCap * velocityCap,
    hue = 0,
    fieldAngleFactorX = 40,
    fieldAngleFactorY = 40,
    fieldMagnitudeFactorX = 50,
    fieldMagnitudeFactorY = 50,
    fieldTimeFactor = 0.004,
    playbackPaused = false,

    currentFrame,
    lastFrame,
    dt,
    dtMax = 1/15,
    timeFactor;

window.onload = function(){
    canvas = document.getElementsByTagName('canvas')[0];
    canvas.width = 1024;
    canvas.height = 760;
    canvasContext = canvas.getContext('2d');
    init();
}

function init(){
    //Initialization
    timeFactor = 0;
    noise.seed(Math.random());
    grid = new Grid(Math.floor(canvas.height / gridSpacing), Math.floor(canvas.width / gridSpacing), canvas.width, canvas.height);
    initializeParticles();
    initializeGUI();
    drawBackground(1.0);
    requestAnimationFrame(main);
}

function initializeParticles(count){
    particleCount = count || Math.floor(canvas.width * canvas.height / 1000); 
    particles = [];
    for (var i = 0; i < particleCount; i ++){
        var particle = new Particle(Math.random() * canvas.width, Math.random() * canvas.height, 2);
        particles.push(particle);
    }
}

function addParticles(count){
	for (var i = 0; i < count; i ++){
        var particle = new Particle(Math.random() * canvas.width, Math.random() * canvas.height, 2);
        particles.push(particle);
    }
    particleCount += count;
}

function removeParticles(count){
	particles.splice(0, count);
	particleCount -= count;
}

function reset(){
	//Initialization
    playbackPaused = false;
    timeFactor = 0;
    noise.seed(Math.random());
    grid = new Grid(Math.floor(canvas.height / gridSpacing), Math.floor(canvas.width / gridSpacing), canvas.width, canvas.height);
    initializeParticles(particleCount);
    drawBackground(1.0);
    requestAnimationFrame(main);
}

function main(){
    currentFrame = new Date();
    dt = (currentFrame - lastFrame) / 1000.0;
    dt = (dt < dtMax)? dt : dtMax; //cap dt in the event of tabbing away
    updateGuiMetrics();


    lastFrame = currentFrame;
    timeFactor += fieldTimeFactor;
    update(dt);
    draw();
    if (playbackPaused){
    	return;
    }
    requestAnimationFrame(main);
}

function update(dt){
    //Update field and particles
    grid.update();
    updateParticles(dt);
}

function updateParticles(dt){
    for (var i = 0; i < particleCount; i++){
        //FIX add to quadtree
        particles[i].update(dt);
    }
}

function draw(){
    drawBackground();
   	//grid.draw();
    drawParticles();
}

function drawBackground(alpha){
    
    canvasContext.fillStyle = `rgba(255, 255, 255, ${alpha || 0.001})`;
    canvasContext.fillRect(0,0,canvas.width, canvas.height);
    
}
function drawParticles(){
    hue += 0.5;
    canvasContext.fillStyle = `hsla(${hue}, 50%, 50%, 0.1)`;
    for (var i = 0; i < particleCount; i++){
        particles[i].draw();
    }
}
/*
var image = canvasContext.createImageData(canvas.width, canvas.height);
var data = image.data;
var start = Date.now();
noise.seed(Math.random());
for (var x = 0; x < canvas.width; x++) {
    for (var y = 0; y < canvas.height; y++) {
        var value = Math.abs(noise.simplex3(x / 100, y / 100, 0));
        value *= 256;
        var cell = (x + y * canvas.width) * 4;
       
        data[cell] = data[cell + 1] = data[cell + 2] = value;
        data[cell + 3] = 255; // alpha.
        //data[cell] += Math.max(0, (25 - value) * 8);

    }
}

canvasContext.putImageData(image, 0, 0);
*/
</script>
</html>